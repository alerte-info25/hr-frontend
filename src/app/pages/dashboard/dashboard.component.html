<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div>
      <h1 class="dashboard-title">Tableau de bord</h1>
      <p class="dashboard-subtitle">Vue d'ensemble des permissions</p>
    </div>

    <!-- Filtres -->
    <div class="filters">
      <select
        [(ngModel)]="selectedEmployeId"
        (change)="onEmployeChange($any($event.target).value)"
        class="filter-select"
        *ngIf="dashboardData()">
        <option value="">Tous les employ√©s</option>
        <option
          *ngFor="let employe of dashboardData()!.liste_employes"
          [value]="employe.slug">
          {{ employe.nom_complet }}
        </option>
      </select>

      <select
        [(ngModel)]="selectedPeriode"
        (change)="onPeriodeChange($any($event.target).value)"
        class="filter-select">
        <option value="jour">Aujourd'hui</option>
        <option value="semaine">Cette semaine</option>
        <option value="mois">Ce mois</option>
        <option value="annee">Cette ann√©e</option>
        <option value="personnalise">P√©riode personnalis√©e</option>
      </select>

      <button
        *ngIf="selectedEmployeId() || selectedPeriode() !== 'mois' || dateDebut || dateFin"
        (click)="resetAllFilters()"
        class="btn-reset-filters"
        title="R√©initialiser tous les filtres">
        <span class="material-icons">restart_alt</span>
        R√©initialiser
      </button>


      <div *ngIf="showCustomDatePicker()" class="custom-date-picker">
        <div class="date-inputs">
          <div class="date-input-group">
            <label for="dateDebut">Date de d√©but</label>
            <input
              type="date"
              id="dateDebut"
              [(ngModel)]="dateDebut"
              (change)="onCustomDateChange()"
              class="date-input"
              [max]="dateFin || undefined"
            />
          </div>

          <div class="date-input-group">
            <label for="dateFin">Date de fin</label>
            <input
              type="date"
              id="dateFin"
              [(ngModel)]="dateFin"
              (change)="onCustomDateChange()"
              class="date-input"
              [min]="dateDebut || undefined"
            />
          </div>

          <button
            *ngIf="dateDebut || dateFin"
            (click)="resetCustomDates()"
            class="btn-reset"
            title="R√©initialiser">
            <i class="icon-close">‚úï</i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div *ngIf="isLoading()" class="loader-container">
    <div class="loader"></div>
    <p>Chargement des donn√©es...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading() && dashboardData()" class="dashboard-content">
    <div *ngIf="selectedEmployeId()" class="active-filter-badge">
      <span class="material-icons">person</span>
      <span>
        Filtr√© par employ√© : {{ selectedEmployeNom }}
      </span>
      <button (click)="onEmployeChange('')" class="btn-close-filter">
        <span class="material-icons">close</span>
      </button>
    </div>
    <!-- KPIs Cards -->
    <div class="kpis-grid">
      <!-- Total -->
      <div class="kpi-card kpi-primary">
        <div class="kpi-header">
          <span class="kpi-icon material-icons">bar_chart</span>
          <span class="kpi-label">{{ dashboardData()!.kpis.total.libelle }}</span>
        </div>
        <div class="kpi-value">{{ dashboardData()!.kpis.total.valeur }}</div>
        <div class="kpi-footer" *ngIf="dashboardData()!.kpis.total.tendance !== undefined">
          <span [class.positive]="dashboardData()!.kpis.total.tendance! > 0"
                [class.negative]="dashboardData()!.kpis.total.tendance! < 0">
            {{ dashboardData()!.kpis.total.tendance! > 0 ? '‚Üë' : '‚Üì' }}
            <!-- {{ Math.abs(dashboardData()!.kpis.total.tendance) }}% -->
            {{ dashboardData()!.kpis.total.tendance | abs }}%
           </span>
          <span class="kpi-footer-text">vs p√©riode pr√©c√©dente</span>
        </div>
      </div>

      <!-- En attente -->
      <div class="kpi-card kpi-warning">
        <div class="kpi-header">
          <span class="material-icons">hourglass_empty</span>
          <span class="kpi-label">{{ dashboardData()!.kpis.en_attente.libelle }}</span>
        </div>
        <div class="kpi-value">{{ dashboardData()!.kpis.en_attente.valeur }}</div>
        <div class="kpi-footer">
          <span class="kpi-percentage">{{ dashboardData()!.kpis.en_attente.pourcentage }}%</span>
          <span class="kpi-footer-text">du total</span>
        </div>
      </div>

      <!-- Approuv√©es -->
      <div class="kpi-card kpi-success">
        <div class="kpi-header">
          <span class="material-icons">check_circle</span>
          <span class="kpi-label">{{ dashboardData()!.kpis.approuvees.libelle }}</span>
        </div>
        <div class="kpi-value">{{ dashboardData()!.kpis.approuvees.valeur }}</div>
        <div class="kpi-footer">
          <span class="kpi-percentage">{{ dashboardData()!.kpis.approuvees.pourcentage }}%

          </span>
          <span class="kpi-footer-text">du total</span>
        </div>
      </div>

      <!-- Refus√©es -->
      <div class="kpi-card kpi-danger">
        <div class="kpi-header">
          <span class="material-icons">cancel</span>
          <span class="kpi-label">{{ dashboardData()!.kpis.refusees.libelle }}</span>
        </div>
        <div class="kpi-value">{{ dashboardData()!.kpis.refusees.valeur }}</div>
        <div class="kpi-footer">
          <span class="kpi-percentage">{{ dashboardData()!.kpis.refusees.pourcentage }}%</span>
          <span class="kpi-footer-text">du total</span>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
      <!-- √âvolution -->
      <div class="chart-card chart-large">
        <h3 class="chart-title">
          <span class="material-icons">trending_up</span>
          √âvolution des demandes
        </h3>
        <div class="chart-container">
          <canvas id="evolutionChart"></canvas>
        </div>
      </div>

      <!-- R√©partition par statut -->
      <div class="chart-card">
        <h3 class="chart-title">
          <span class="material-icons">donut_small</span>
          R√©partition par statut
        </h3>
        <div class="chart-container">
          <canvas id="statutChart"></canvas>
        </div>
        <div class="chart-info">
          <div class="info-item">
            <span class="info-label">Taux d'approbation</span>
            <span class="info-value">{{ dashboardData()!.kpis.taux_approbation }}%</span>
          </div>
        </div>
      </div>

      <!-- R√©partition par type -->
      <div class="chart-card">
        <h3 class="chart-title">
          <span class="material-icons">assignment</span>
          R√©partition par type
        </h3>
        <div class="chart-container">
          <canvas id="typeChart"></canvas>
        </div>
      </div>

      <!-- R√©partition par genre -->
      <div class="chart-card">
        <h3 class="chart-title">
          <span class="material-icons">people</span>
          R√©partition par genre
        </h3>
        <div class="chart-container">
          <canvas id="genreChart"></canvas>
        </div>
      </div>

      <!-- R√©partition par service -->
      <div class="chart-card chart-large">
        <h3 class="chart-title">
          <span class="material-icons">business</span>
          R√©partition par service
        </h3>
        <div class="chart-container">
          <canvas id="serviceChart"></canvas>
        </div>
      </div>

    </div>

    <!-- Top employ√©s -->
    <div class="section-card">
      <h3 class="section-title">
        <span class="material-icons">groups</span>
        Top 10 des employ√©s (dur√©e totale)
      </h3>

      <div class="top-list">
        <div
          *ngFor="let employe of dashboardData()!.top_employes; let i = index"
          class="top-item">

          <!-- Rang avec m√©daille pour le top 3 -->
          <div class="top-rank" [class.medal]="i < 3">
            <span *ngIf="i === 0" class="medal-icon gold">ü•á</span>
            <span *ngIf="i === 1" class="medal-icon silver">ü•à</span>
            <span *ngIf="i === 2" class="medal-icon bronze">ü•â</span>
            <span *ngIf="i >= 3">{{ i + 1 }}</span>
          </div>

          <!-- Nom de l'employ√© -->
          <div class="top-name">{{ employe.employe }}</div>

          <!-- Barre de progression -->
          <div class="top-bar-container">
            <div
              class="top-bar"
              [style.width.%]="getTopEmployeBarWidth(employe)"
              [style.background-color]="getTopEmployeColor(i)">
            </div>
          </div>

          <!-- Dur√©e format√©e -->
          <div class="top-value">{{ employe.total }}</div>
        </div>
      </div>

      <!-- Message si aucune donn√©e -->
      <div *ngIf="dashboardData()!.top_employes.length === 0" class="no-data">
        <span class="material-icons">info</span>
        <p>Aucune donn√©e disponible pour cette p√©riode</p>
      </div>
    </div>

    <!--  Tableau des services -->
    <div class="section-card">
      <h3 class="section-title">
        <span class="material-icons">business</span>
        D√©tails par service
      </h3>
      <div class="table-container">
        <table class="services-table">
          <thead>
            <tr>
              <th>Service</th>
              <th>Total</th>
              <th>Approuv√©es</th>
              <th>En attente</th>
              <th>Refus√©es</th>
              <th>Taux d'approbation</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let service of dashboardData()!.repartition_services">
              <td class="service-name">{{ service.service }}</td>
              <td class="text-center"><strong>{{ service.total }}</strong></td>
              <td class="text-center">
                <span class="badge badge-success">{{ service.approuvees }}</span>
              </td>
              <td class="text-center">
                <span class="badge badge-warning">{{ service.en_attente }}</span>
              </td>
              <td class="text-center">
                <span class="badge badge-danger">{{ service.refusees }}</span>
              </td>
              <td class="text-center">
                <span class="taux-approbation">
                  {{ service.total > 0 ? ((service.approuvees / service.total) * 100).toFixed(1) : 0 }}%
                </span>
              </td>
            </tr>
            <tr *ngIf="dashboardData()!.repartition_services.length === 0">
              <td colspan="6" class="empty-cell">Aucune donn√©e disponible</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Demandes r√©centes -->
    <div class="section-card">
      <h3 class="section-title">
        <span class="material-icons">notifications_active</span>
        Demandes r√©centes en attente
      </h3>
      <div class="table-container">
        <table class="demandes-table">
          <thead>
            <tr>
              <th>Employ√©</th>
              <th>Type</th>
              <th>Date demande</th>
              <th>P√©riode</th>
              <th>Raison</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let demande of dashboardData()!.demandes_recentes">
              <td class="employe-cell">{{ demande.employe }}</td>
              <td><span class="type-badge">{{ demande.type }}</span></td>
              <td>{{ demande.date_demande }}</td>
              <td>{{ demande.debut }} - {{ demande.fin }}</td>
              <td class="raison-cell">{{ demande.raison }}</td>
            </tr>
            <tr *ngIf="dashboardData()!.demandes_recentes.length === 0">
              <td colspan="5" class="empty-cell">Aucune demande en attente</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

