@if(isLoading){
  <app-loading></app-loading>
}

<div class="wizard-container">
  <!-- En-tête du wizard -->
  <div class="wizard-header">
    <a routerLink="/employes">
      <button class="btn-back">
        <span class="material-icons">arrow_back</span> Retour
      </button>
    </a>

    <h2>Ajouter un Nouvel Employé</h2>

    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgress()"></div>
      </div>
      <span class="progress-text">Étape {{ currentStep }} sur {{ totalSteps }}</span>
    </div>
  </div>

  <!-- Navigation des étapes -->
  <div class="steps-navigation">
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
      <div class="step-number">
        <span class="material-icons">person</span>
      </div>
      <div class="step-label">Informations Personnelles</div>
    </div>

    <div class="step-separator"></div>

    <div class="step" [class.active]="currentStep === 2">
      <div class="step-number">
        <span class="material-icons">badge</span>
      </div>
      <div class="step-label">Informations Professionnelles</div>
    </div>
  </div>

  <!-- Contenu du wizard -->
  <div class="wizard-content">

    <!-- Étape 1: Informations Personnelles -->
    <div *ngIf="currentStep === 1" class="step-content">
      <h3>Informations Personnelles</h3>
      <form [formGroup]="personalInfoForm" class="form-grid">

        <div class="form-row">
          <div class="form-group">
            <label for="nom">Nom *</label>
            <input
              type="text"
              id="nom"
              formControlName="nom"
              [class.error]="isFieldInvalid(personalInfoForm, 'nom')"
              placeholder="Entrez le nom">
            <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'nom')">
              {{ getFieldError(personalInfoForm, 'nom') }}
            </div>
          </div>

          <div class="form-group">
            <label for="prenom">Prénom *</label>
            <input
              type="text"
              id="prenom"
              formControlName="prenom"
              [class.error]="isFieldInvalid(personalInfoForm, 'prenom')"
              placeholder="Entrez le prénom">
            <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'prenom')">
              {{ getFieldError(personalInfoForm, 'prenom') }}
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="genre">Genre *</label>
          <select
            id="genre"
            formControlName="genre"
            [class.error]="isFieldInvalid(personalInfoForm, 'genre')">
            <option value="" disabled selected>Sélectionner le genre</option>
            <option value="m">Masculin</option>
            <option value="f">Féminin</option>
          </select>
          <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'genre')">
            {{ getFieldError(personalInfoForm, 'genre') }}
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="dateNaissance">Date de Naissance *</label>
            <input
              type="date"
              id="dateNaissance"
              formControlName="dateNaissance"
              [class.error]="isFieldInvalid(personalInfoForm, 'dateNaissance')">
            <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'dateNaissance')">
              {{ getFieldError(personalInfoForm, 'dateNaissance') }}
            </div>
          </div>

          <div class="form-group">
            <label for="lieuNaissance">Lieu de Naissance *</label>
            <input
              type="text"
              id="lieuNaissance"
              formControlName="lieuNaissance"
              [class.error]="isFieldInvalid(personalInfoForm, 'lieuNaissance')"
              placeholder="Ville, Pays">
            <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'lieuNaissance')">
              {{ getFieldError(personalInfoForm, 'lieuNaissance') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="emailPersonnel">Email Personnel *</label>
            <input
              type="email"
              id="emailPersonnel"
              formControlName="emailPersonnel"
              [class.error]="isFieldInvalid(personalInfoForm, 'emailPersonnel')"
              placeholder="exemple@email.com">
            <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'emailPersonnel')">
              {{ getFieldError(personalInfoForm, 'emailPersonnel') }}
            </div>
          </div>

          <div class="form-group">
            <label for="telephone">Téléphone *</label>
            <input
              type="tel"
              id="telephone"
              formControlName="telephone"
              [class.error]="isFieldInvalid(personalInfoForm, 'telephone')"
              placeholder="+225 07 12 34 56 78">
            <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'telephone')">
              {{ getFieldError(personalInfoForm, 'telephone') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="nationalite">Nationalité *</label>
            <select
              id="nationalite"
              formControlName="nationalite"
              [class.error]="isFieldInvalid(personalInfoForm, 'nationalite')">
              <option value="">Sélectionnez une nationalité</option>
              <option *ngFor="let nat of nationalites" [value]="nat.nom">{{ nat.nom }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'nationalite')">
              {{ getFieldError(personalInfoForm, 'nationalite') }}
            </div>
          </div>

          <div class="form-group">
            <label for="paysResidence">Pays de résidence *</label>
            <select
              id="paysResidence"
              formControlName="paysResidence"
              [class.error]="isFieldInvalid(personalInfoForm, 'paysResidence')">
              <option disabled value="">Sélectionnez votre pays de résidence</option>
              <option *ngFor="let pay of pays" [value]="pay.nom">{{ pay.nom }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'paysResidence')">
              {{ getFieldError(personalInfoForm, 'paysResidence') }}
            </div>
          </div>
        </div>

        <div class="form-group full-width">
          <label for="adresse">Adresse Complète *</label>
          <textarea
            id="adresse"
            formControlName="adresse"
            [class.error]="isFieldInvalid(personalInfoForm, 'adresse')"
            placeholder="Numéro, rue, ville, code postal"
            rows="3"></textarea>
          <div class="error-message" *ngIf="isFieldInvalid(personalInfoForm, 'adresse')">
            {{ getFieldError(personalInfoForm, 'adresse') }}
          </div>
        </div>

      </form>
    </div>

    <!-- Étape 2: Informations Professionnelles -->
    <div *ngIf="currentStep === 2" class="step-content">
      <h3>Informations Professionnelles</h3>
      <form [formGroup]="professionalInfoForm" class="form-grid">

        <div class="form-row">
          <div class="form-group">
            <label for="emailProfessionnel">Email Professionnel</label>
            <input
              type="email"
              id="emailProfessionnel"
              formControlName="emailProfessionnel"
              [class.error]="isFieldInvalid(professionalInfoForm, 'emailProfessionnel')"
              placeholder="prenom.nom@entreprise.com">
            <div class="error-message" *ngIf="isFieldInvalid(professionalInfoForm, 'emailProfessionnel')">
              {{ getFieldError(professionalInfoForm, 'emailProfessionnel') }}
            </div>
          </div>

          <div class="form-group">
            <label for="numeroSocial">Numéro social</label>
            <input
              type="text"
              id="numeroSocial"
              formControlName="numeroSocial"
              [class.error]="isFieldInvalid(professionalInfoForm, 'numeroSocial')"
              placeholder="Entrez le numéro social">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="typePiece">Type de Pièce d'Identité *</label>
            <select
              id="typePiece"
              formControlName="typePiece"
              [class.error]="isFieldInvalid(professionalInfoForm, 'typePiece')">
              <option value="">Sélectionnez un type de pièce</option>
              <option *ngFor="let type of typesPiece" [value]="type">{{ type }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid(professionalInfoForm, 'typePiece')">
              {{ getFieldError(professionalInfoForm, 'typePiece') }}
            </div>
          </div>

          <div class="form-group">
            <label for="numeroPiece">Numéro de Pièce *</label>
            <input
              type="text"
              id="numeroPiece"
              formControlName="numeroPiece"
              [class.error]="isFieldInvalid(professionalInfoForm, 'numeroPiece')"
              placeholder="Numéro de la pièce d'identité">
            <div class="error-message" *ngIf="isFieldInvalid(professionalInfoForm, 'numeroPiece')">
              {{ getFieldError(professionalInfoForm, 'numeroPiece') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="id_service">Service *</label>
            <select
              id="id_service"
              formControlName="id_service"
              [class.error]="isFieldInvalid(professionalInfoForm, 'id_service')">
              <option value="">Sélectionnez son service</option>
              <option *ngFor="let service of services" [value]="service.slug">{{ service.nom }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid(professionalInfoForm, 'id_service')">
              {{ getFieldError(professionalInfoForm, 'id_service') }}
            </div>
          </div>

          <div class="form-group">
            <label for="id_fonction">Fonction *</label>
            <select
              id="id_fonction"
              formControlName="id_fonction"
              [class.error]="isFieldInvalid(professionalInfoForm, 'id_fonction')">
              <option value="">Sélectionnez sa fonction</option>
              <option *ngFor="let fonction of fonctions" [value]="fonction.slug">{{ fonction.nom }}</option>
            </select>
            <div class="error-message" *ngIf="isFieldInvalid(professionalInfoForm, 'id_fonction')">
              {{ getFieldError(professionalInfoForm, 'id_fonction') }}
            </div>
          </div>
        </div>

        <div class="form-group full-width">
          <label for="photo">Photo de Profil</label>
          <div class="photo-upload-container">
            <input
              type="file"
              id="photo"
              accept="image/*"
              (change)="onFileSelected($event)"
              class="file-input">

            <div class="photo-preview" *ngIf="photoPreview">
              <img [src]="photoPreview" alt="Aperçu photo" class="preview-image">
              <button type="button" class="remove-photo-btn" (click)="removePhoto()">
                <span class="material-icons">close</span>
              </button>
            </div>

            <div class="upload-placeholder" *ngIf="!photoPreview">
              <div class="upload-icon">
                <span class="material-icons" style="font-size: 4rem; color: #2563eb;">add_photo_alternate</span>
              </div>
              <p>Cliquez pour sélectionner une photo</p>
              <small>Formats acceptés: JPG, PNG, GIF (Max 5MB)</small>
            </div>
          </div>
        </div>

        <!-- Résumé des informations personnelles -->
        <div class="summary-section">
          <h4>Résumé des Informations Personnelles</h4>
          <div class="summary-grid">
            <div class="summary-item">
              <strong><span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">badge</span> Nom:</strong>
              <span>{{ personalInfoForm.get('nom')?.value || 'Non renseigné' }}</span>
            </div>
            <div class="summary-item">
              <strong><span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">person</span> Prénom:</strong>
              <span>{{ personalInfoForm.get('prenom')?.value || 'Non renseigné' }}</span>
            </div>
            <div class="summary-item">
              <strong><span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">email</span> Email:</strong>
              <span>{{ personalInfoForm.get('emailPersonnel')?.value || 'Non renseigné' }}</span>
            </div>
            <div class="summary-item">
              <strong><span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">phone</span> Téléphone:</strong>
              <span>{{ personalInfoForm.get('telephone')?.value || 'Non renseigné' }}</span>
            </div>
          </div>
        </div>

      </form>
    </div>

  </div>

  <!-- Navigation du wizard -->
  <div class="wizard-navigation">
    <button
      type="button"
      class="btn btn-secondary"
      [disabled]="currentStep === 1"
      (click)="previousStep()">
      <span class="material-icons">arrow_back</span>
      Précédent
    </button>

    <button
      type="button"
      class="btn btn-primary"
      *ngIf="currentStep < totalSteps"
      (click)="nextStep()">
      Suivant
      <span class="material-icons">arrow_forward</span>
    </button>

    <button
      type="button"
      class="btn btn-success"
      *ngIf="currentStep === totalSteps"
      [disabled]="!personalInfoForm.valid || !professionalInfoForm.valid"
      (click)="onSubmit()">
      <span class="material-icons">check_circle</span>
      Enregistrer
    </button>

    <button
      type="button"
      class="btn btn-outline"
      (click)="resetWizard()">
      <span class="material-icons">restart_alt</span>
      Annuler
    </button>
  </div>

</div>
