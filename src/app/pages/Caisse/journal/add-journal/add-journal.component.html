<!-- Loader -->
<app-loader />

<div class="container-fluid px-4">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2 class="page-title">
          <i class="fas fa-plus-circle me-2"></i>
          Nouvelle écriture comptable
        </h2>
        <p class="text-muted mb-0">
          Saisissez une nouvelle écriture dans le journal -
          {{ exerciceSelectionne }}
        </p>
      </div>
    </div>
  </div>

  <!-- Alertes -->
  @if (success()) {
    <div class="alert alert-success">Écriture enregistrée avec succès.</div>
  }
  @if (errorMessage()) {
    <div class="alert alert-danger">{{ errorMessage() }}</div>
  }

  <!-- Quick Info -->
  <div class="quick-info">
    <i class="fas fa-lightbulb"></i>
    <div>
      <strong>Conseil :</strong> Une écriture doit être équilibrée (total débit
      = total crédit). Vous pouvez ajouter autant de lignes que nécessaire.
    </div>
  </div>

  <!-- Formulaire principal -->
  <div class="form-container">
    <form [formGroup]="journalForm" (ngSubmit)="onSubmit()" id="entryForm">
      <!-- Section entête -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-file-invoice"></i>
          Informations générales
        </div>

        <div class="row g-4">
          <!-- Date -->
          <div class="col-md-3">
            <label class="form-label">
              <i class="far fa-calendar me-1 text-warning"></i>
              Date *
            </label>
            <input
              type="date"
              class="form-control"
              formControlName="date_operation"
              [class.is-invalid]="
                journalForm.get('date_operation')?.invalid &&
                journalForm.get('date_operation')?.touched
              "
            />
            <div class="invalid-feedback">La date est requise.</div>
          </div>

          <!-- Bureau -->
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-building me-1 text-warning"></i>
              Bureau *
            </label>
            <select
              class="form-select"
              formControlName="bureau_rfk"
              [class.is-invalid]="
                journalForm.get('bureau_rfk')?.invalid &&
                journalForm.get('bureau_rfk')?.touched
              "
            >
              <option value="">Sélectionnez...</option>
              @if (loaderSelects()) {
                <option disabled>Chargement...</option>
              }
              @for (bureau of bureaux(); track bureau.rfk) {
                <option [value]="bureau.rfk">{{ bureau.libelle }}</option>
              }
            </select>
            <div class="invalid-feedback">Le bureau est requis.</div>
          </div>

          <!-- Nature opération -->
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-book me-1 text-warning"></i>
              Nature de l'opération *
            </label>
            <select
              class="form-select"
              formControlName="nature_operation_comptable_rfk"
              [class.is-invalid]="
                journalForm.get('nature_operation_comptable_rfk')?.invalid &&
                journalForm.get('nature_operation_comptable_rfk')?.touched
              "
            >
              <option value="">Sélectionnez...</option>
              @if (loaderSelects()) {
                <option disabled>Chargement...</option>
              }
              @for (nature of natures(); track nature.rfk) {
                <option [value]="nature.rfk">{{ nature.libelle }}</option>
              }
            </select>
            <div class="invalid-feedback">La nature est requise.</div>
          </div>

          <!-- Exercice -->
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-calendar-alt me-1 text-warning"></i>
              Exercice comptable *
            </label>
            <select
              class="form-select"
              formControlName="exercice_comptable_rfk"
              [class.is-invalid]="
                journalForm.get('exercice_comptable_rfk')?.invalid &&
                journalForm.get('exercice_comptable_rfk')?.touched
              "
            >
              <option value="">Sélectionnez...</option>
              @if (loaderSelects()) {
                <option disabled>Chargement...</option>
              }
              @for (exercice of exercices(); track exercice.rfk) {
                @if (exercice.statut !== "cloture") {
                  <option [value]="exercice.rfk">{{ exercice.libelle }}</option>
                }
              } @empty {
                <option disabled>
                  Veuillez créer d'abord un exercice comptable
                </option>
              }
            </select>
            <div class="invalid-feedback">L'exercice est requis.</div>
          </div>

          <!-- Libellé général -->
          <div class="col-md-12">
            <label class="form-label">
              <i class="fas fa-tag me-1 text-warning"></i>
              Libellé général *
            </label>
            <input
              type="text"
              class="form-control"
              formControlName="libelle"
              placeholder="Description de l'écriture"
              [class.is-invalid]="
                journalForm.get('libelle')?.invalid &&
                journalForm.get('libelle')?.touched
              "
            />
            <div class="invalid-feedback">Le libellé est requis.</div>
          </div>
        </div>
      </div>

      <!-- Section lignes d'écriture -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-list"></i>
          Lignes d'écriture
        </div>

        <div class="journal-lines-container">
          <table class="journal-lines-table">
            <thead>
              <tr>
                <th width="30%">Compte *</th>
                <th width="30%">Libellé ligne</th>
                <th width="15%">Débit (Fcfa)</th>
                <th width="15%">Crédit (Fcfa)</th>
                <th width="10%"></th>
              </tr>
            </thead>
            <tbody formArrayName="lignes">
              @for (ligne of lignes.controls; track $index) {
                <tr class="line-row" [formGroupName]="$index">
                  <!-- Compte -->
                  <td>
                    <select
                      class="form-select form-select-sm account-select"
                      formControlName="compte_comptable_rfk"
                    >
                      <option value="">Sélectionnez...</option>
                      @if (comptes().length > 0) {
                        <optgroup label="Comptes enregistrés">
                          @for (compte of comptes(); track compte.rfk) {
                            <option [value]="compte.rfk">
                              {{ compte.numero }} - {{ compte.libelle }}
                            </option>
                          }
                        </optgroup>
                      }
                    </select>
                  </td>

                  <!-- Libellé ligne -->
                  <td>
                    <input
                      type="text"
                      class="form-control form-control-sm"
                      formControlName="libelle"
                      placeholder="Libellé de la ligne"
                    />
                  </td>

                  <!-- Débit -->
                  <td>
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      formControlName="montant_debit"
                      step="0.01"
                      min="0"
                      placeholder="0,00"
                      (input)="onMontantChange($index, 'montant_debit')"
                    />
                  </td>

                  <!-- Crédit -->
                  <td>
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      formControlName="montant_credit"
                      step="0.01"
                      min="0"
                      placeholder="0,00"
                      (input)="onMontantChange($index, 'montant_credit')"
                    />
                  </td>

                  <!-- Supprimer -->
                  <td class="text-center">
                    <button
                      type="button"
                      class="btn-remove-line"
                      (click)="supprimerLigne($index)"
                      [disabled]="lignes.length <= 2"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>

          <button
            type="button"
            class="btn-add-line mt-3"
            (click)="ajouterLigne()"
          >
            <i class="fas fa-plus-circle me-2"></i>
            Ajouter une ligne
          </button>
        </div>

        <!-- Totaux -->
        <div class="totals-panel">
          <div class="total-row">
            <span class="total-label">Total Débit :</span>
            <span class="total-value debit">
              {{ formatMontant(totaux().totalDebit) }} Fcfa
            </span>
          </div>
          <div class="total-row">
            <span class="total-label">Total Crédit :</span>
            <span class="total-value credit">
              {{ formatMontant(totaux().totalCredit) }} Fcfa
            </span>
          </div>
          <div class="total-row">
            <span class="total-label">Différence :</span>
            <span
              class="total-value balance"
              [class.text-success]="totaux().difference === 0"
              [class.text-danger]="totaux().difference !== 0"
            >
              {{ formatMontant(totaux().difference) }} Fcfa
            </span>
            @if (totaux().difference !== 0) {
              <span class="balance-warning">
                <i class="fas fa-exclamation-triangle me-1"></i>
                Écriture non équilibrée
              </span>
            }
          </div>
        </div>
      </div>

      <!-- Section pièce jointe -->
      <!-- <div class="form-section">
        <div class="section-title">
          <i class="fas fa-cog"></i>
          Justifications comptables
        </div>

        <div class="mt-3">
          <label class="form-label">
            <i class="fas fa-paperclip me-1 text-warning"></i>
            Pièce jointe
          </label>
          <div class="border rounded p-3 bg-light">
            <div class="d-flex align-items-center gap-3">
              @if (pieceJointe()) {
                <i class="fas fa-file text-primary fs-1"></i>
                <div>
                  <p class="mb-1 fw-bold">{{ pieceJointeNom() }}</p>
                  <p class="mb-0 small text-muted">
                    {{ (pieceJointe()!.size / 1024).toFixed(0) }} Ko
                  </p>
                </div>
              } @else {
                <i class="fas fa-file-upload text-muted fs-1"></i>
                <div>
                  <p class="mb-1 fw-bold text-muted">
                    Aucun fichier sélectionné
                  </p>
                  <p class="mb-0 small text-muted">PDF, JPG, PNG acceptés</p>
                </div>
              }
              <button
                type="button"
                class="btn btn-sm btn-outline-primary ms-auto"
                (click)="changerPieceJointe()"
              >
                <i class="fas fa-upload me-1"></i>
                {{ pieceJointe() ? "Changer" : "Ajouter" }}
              </button>
            </div>
          </div>
        </div>
      </div> -->
    </form>
  </div>

  <!-- Barre d'actions sticky -->
  <div class="action-bar">
    <button type="button" class="btn btn-outline-secondary" (click)="annuler()">
      <i class="fas fa-times me-2"></i>
      Annuler
    </button>
    <button
      type="submit"
      form="entryForm"
      class="btn btn-primary"
      [disabled]="loader() || totaux().difference !== 0 || journalForm.invalid"
    >
      @if (loader()) {
        <i class="fas fa-spinner fa-spin me-2"></i>
        Enregistrement...
      } @else {
        <i class="fas fa-save me-2"></i>
        Enregistrer l'écriture
      }
    </button>
  </div>
</div>
