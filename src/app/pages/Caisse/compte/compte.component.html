<div class="container-fluid px-4">
  <!-- Page Header -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h2 class="page-title">
          <i class="fas fa-file-invoice me-2"></i>
          Comptes enregistrés
        </h2>
        <p class="page-subtitle">
          Gérez la liste des comptes comptables, leur classification et
          consultez leur activité
        </p>
      </div>
    </div>
  </div>

  @if (loader()) {
    <app-loader />
  }

  @if (succes()) {
    <div class="alert alert-success">Opération réussie.</div>
  }

  @if (errorMessage()) {
    <div class="alert alert-danger">{{ errorMessage() }}</div>
  }

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-xl-4 col-md-6 mb-4">
      <div class="stats-card">
        <div class="stats-icon blue">
          <i class="fas fa-calculator"></i>
        </div>
        <div class="stats-label">Total comptes</div>
        <div class="stats-value">{{ TotalcountAccount() ?? "0" }}</div>
        <div class="stats-trend"></div>
      </div>
    </div>
    <div class="col-xl-4 col-md-6 mb-4">
      <div class="stats-card">
        <div class="stats-icon yellow">
          <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="stats-label">Comptes actifs</div>
        <div class="stats-value">{{ TotalActifcountAccount() ?? "0" }}</div>
        <div class="stats-trend"></div>
      </div>
    </div>
    <div class="col-xl-4 col-md-6 mb-4">
      <div class="stats-card">
        <div class="stats-icon green" style="background: crimson; color: #fff">
          <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="stats-label">Comptes inactifs</div>
        <div class="stats-value">{{ TotalInactifcountAccount() ?? "0" }}</div>
      </div>
    </div>
  </div>

  <!-- Right Sidebar - Quick Info & Stats -->
  <div class="quick-actions">
    <h5 class="mb-3">Top 5 comptes les plus actifs</h5>

    @for (compte of topActifs(); track compte.rfk; let first = $first) {
      <div [class]="first ? 'mb-4' : 'mb-3'">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span>
            <strong>{{ compte.numero }}</strong> - {{ compte.libelle }}
          </span>
          <span class="text-primary fw-bold"
            >{{ compte.nb_operations }} opérations.</span
          >
        </div>
        <div class="progress" style="height: 8px">
          <div
            class="progress-bar"
            [style.width]="getPourcentage(compte.nb_operations) + '%'"
          ></div>
        </div>
      </div>
    }

    @if (topActifs().length === 0) {
      <p class="text-muted">Aucune activité enregistrée.</p>
    }
  </div>

  <!-- Toolbar -->
  <div class="accounts-toolbar">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input
        type="text"
        id="searchAccount"
        placeholder="Rechercher un compte (code, nom, description...)"
        autocomplete="off"
        [ngModel]="recherche()"
        (ngModelChange)="onRecherche($event)"
      />
    </div>

    <div class="filter-group">
      <select
        class="filter-select"
        [(ngModel)]="filtreClasse"
        (ngModelChange)="onFiltreChange()"
      >
        <option value="">Toutes les classes</option>
        @for (classe of classes(); track classe.rfk) {
          <option [value]="classe.rfk">{{ classe.libelle }}</option>
        }
      </select>

      <select
        class="filter-select"
        [(ngModel)]="filtreType"
        (ngModelChange)="onFiltreChange()"
      >
        <option value="">Type de compte</option>
        @for (type of types(); track type.rfk) {
          <option [value]="type.rfk">{{ type.libelle }}</option>
        }
      </select>

      <select
        class="filter-select"
        [(ngModel)]="filtreCategorie"
        (ngModelChange)="onFiltreChange()"
      >
        <option value="">Catégorie de compte</option>
        @for (categorie of categories(); track categorie.rfk) {
          <option [value]="categorie.rfk">{{ categorie.libelle }}</option>
        }
      </select>

      <select
        class="filter-select"
        [(ngModel)]="filtreStatut"
        (ngModelChange)="onFiltreChange()"
      >
        <option value="">Statut</option>
        <option value="actif">Actif</option>
        <option value="inactif">Inactif</option>
      </select>
    </div>

    <a
      routerLink="/caisse/add-compte"
      class="btn-new-account"
      style="text-decoration: none"
    >
      <i class="fas fa-plus-circle"></i>
      Nouveau compte
    </a>
  </div>

  <div class="row">
    <!-- Main Accounts Table -->
    <div class="col-lg-16">
      <div class="accounts-table-container">
        <div class="table-responsive">
          <table class="accounts-table" id="accountsTable">
            <thead>
              <tr>
                <th>Numéro compte</th>
                <th>Libellé</th>
                <th>Classe</th>
                <th>Type</th>
                <th>Catégorie</th>
                <th>Opérations</th>
                <th>Total débit (Fcfa)</th>
                <th>Total crédit (Fcfa)</th>
                <th>Total (Fcfa)</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @if (loader()) {
                <span>Chargement des comptes...</span>
              } @else {
                @for (compte of comptes(); track compte.rfk) {
                  <tr>
                    <td>
                      <span class="account-code">{{ compte?.numero }}</span>
                    </td>
                    <td>
                      <div class="account-name">
                        {{ compte?.libelle }}
                      </div>
                      <div class="account-description">
                        {{ compte?.description }}
                      </div>
                    </td>
                    <td>
                      <span class="account-type">
                        {{ compte?.classe_comptable?.libelle }}
                      </span>
                    </td>
                    <td>
                      <span class="account-type">
                        {{ compte?.type_compte_comptable?.libelle }}
                      </span>
                    </td>
                    <td>
                      <span class="account-type">
                        {{ compte?.categorie_comptable?.libelle }}
                      </span>
                    </td>
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <span class="stats-badge"
                          ><i class="fas fa-pen"></i> {{ compte.nb_operations }}</span
                        >
                      </div>
                    </td>
                    <td>
                      {{ compte.total_debit ?? 0 | number: "1.0-0" }} Fcfa
                    </td>
                    <td>
                      {{ compte.total_credit ?? 0 | number: "1.0-0" }} Fcfa
                    </td>
                    <td
                      [class.text-success]="(compte.solde ?? 0) >= 0"
                      [class.text-danger]="(compte.solde ?? 0) < 0"
                    >
                      {{ compte.solde ?? 0 | number: "1.0-0" }} Fcfa
                    </td>
                    <td>
                      <label class="status-toggle">
                        <input
                          type="checkbox"
                          [checked]="compte.actif"
                          (change)="toggleActif(compte.rfk)"
                        />
                        <span class="status-slider"></span>
                      </label>
                    </td>
                    <td>
                      <div class="action-btns">
                        <button
                          type="button"
                          class="btn-action"
                          (click)="navigateToUpdatePage(compte.rfk)"
                        >
                          <i class="fas fa-edit"></i>
                        </button>

                        <button
                          type="button"
                          class="btn-action delete"
                          (click)="onDelete(compte.rfk)"
                          [disabled]="deleteCountRfk() === compte.rfk"
                        >
                          @if (deleteCountRfk() === compte.rfk) {
                            <i class="fas fa-spinner fa-spin"></i>
                          } @else {
                            <i class="fas fa-trash"></i>
                          }
                        </button>
                      </div>
                    </td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="11">
                      <div
                        class="alert alert-warning mb-0 d-flex justify-content-center"
                      >
                        Aucun compte trouvé !
                      </div>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
