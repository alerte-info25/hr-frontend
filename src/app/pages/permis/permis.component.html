<div class="container-fluid py-4">
  <!-- Messages de succès/erreur -->
  <div *ngIf="messageSucces" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle me-2"></i>{{ messageSucces }}
    <button type="button" class="btn-close" (click)="messageSucces = ''"></button>
  </div>

  <div *ngIf="messageErreur" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>{{ messageErreur }}
    <button type="button" class="btn-close" (click)="messageErreur = ''"></button>
  </div>

  <!-- En-tête -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2  style="color: black;"><mat-icon class="me-2">event_available</mat-icon>Gestion des Permissions</h2>
    <button mat-raised-button color="primary" (click)="goToPermissionsUser()">
      <mat-icon class="me-1">lock</mat-icon>
      Mes permissions
    </button>
  </div>
   <!-- Section: Cartes de synthèse -->
  <div class="row g-4 mb-4">
    <!-- Carte: Total des demandes -->
    <div class="col-md-6 col-lg-3">
      <mat-card class="stat-card">
        <mat-card-content class="d-flex align-items-center">
          <div class="icon-wrapper bg-primary">
            <mat-icon class="stat-icon">description</mat-icon>
          </div>
          <div class="ms-3 flex-grow-1">
            <p class="text-muted mb-1 small">Total des demandes</p>
            <h3 class="mb-0">{{ totalDemandes }}</h3>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Carte: Demandes en attente -->
    <div class="col-md-6 col-lg-3">
      <mat-card class="stat-card">
        <mat-card-content class="d-flex align-items-center">
          <div class="icon-wrapper bg-warning">
            <mat-icon class="stat-icon">hourglass_empty</mat-icon>
          </div>
          <div class="ms-3 flex-grow-1">
            <p class="text-muted mb-1 small">En attente</p>
            <h3 class="mb-0">{{ totalEnAttente }}</h3>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Carte: Demandes acceptées -->
    <div class="col-md-6 col-lg-3">
      <mat-card class="stat-card">
        <mat-card-content class="d-flex align-items-center">
          <div class="icon-wrapper bg-success">
            <mat-icon class="stat-icon">check_circle</mat-icon>
          </div>
          <div class="ms-3 flex-grow-1">
            <p class="text-muted mb-1 small">Acceptées</p>
            <h3 class="mb-0">{{ totalAcceptees }}</h3>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Carte: Demandes refusées -->
    <div class="col-md-6 col-lg-3">
      <mat-card class="stat-card">
        <mat-card-content class="d-flex align-items-center">
          <div class="icon-wrapper bg-danger">
            <mat-icon class="stat-icon">cancel</mat-icon>
          </div>
          <div class="ms-3 flex-grow-1">
            <p class="text-muted mb-1 small">Refusées</p>
            <h3 class="mb-0">{{ totalRefusees }}</h3>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Section: Permissions en attente -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">
        <i class="bi bi-hourglass-split me-2"></i>Permissions en attente
        <span class="badge bg-dark ms-2">{{ permissionsEnAttente.length }}</span>
      </h5>
    </div>
    <div class="card-body">
      <div *ngIf="isLoadingEnAttente" class="text-center py-4">
        <div class="spinner-border text-warning" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
      </div>

      <div *ngIf="!isLoadingEnAttente && permissionsEnAttente.length === 0" class="text-center text-muted py-4">
        <i class="bi bi-inbox fs-1"></i>
        <p class="mt-2">Aucune permission en attente</p>
      </div>

      <div *ngIf="!isLoadingEnAttente && permissionsEnAttente.length > 0" class="table-responsive mobile-table-scroll">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Employé</th>
              <th>Type</th>
              <th>Date demande</th>
              <th>Période</th>
              <th>Durée</th>
              <th>Raison</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let permission of paginatedPermissionsEnAttente">
              <td>
                <strong>{{ permission.employe?.prenom }} {{ permission.employe?.nom }}</strong><br>
              </td>
              <td>
                <span class="badge bg-info">{{ permission.type?.nom }}</span>
              </td>
              <td>{{ formatDate(permission.date_demande) }}</td>
              <td>
                <small>Du {{ formatDate(permission.debut) }}</small><br>
                <small>Au {{ formatDate(permission.fin) }}</small>
              </td>
              <td>
                <strong>{{ calculerDuree(permission.debut, permission.fin) }}</strong>
              </td>
              <td>
                @if(permission.raison){
                  <small>{{ permission?.raison | slice:0:50 }}{{ permission.raison.length > 50 ? '...' : '' }}</small>
                }@else{
                  <small></small>
                }
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button (click)="ouvrirModal(permission)" class="btn btn-sm btn-outline-primary" title="Voir détails">
                    <i class="bi bi-eye"></i> Voir
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <nav *ngIf="totalPagesAttente > 1" class="mt-3">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPageAttente === 1">
            <a class="page-link" (click)="changerPageAttente(currentPageAttente - 1)">‹</a>
          </li>

          <li class="page-item"
              *ngFor="let p of [].constructor(totalPagesAttente); let i = index"
              [class.active]="currentPageAttente === i + 1">
            <a class="page-link" (click)="changerPageAttente(i + 1)">
              {{ i + 1 }}
            </a>
          </li>

          <li class="page-item" [class.disabled]="currentPageAttente === totalPagesAttente">
            <a class="page-link" (click)="changerPageAttente(currentPageAttente + 1)">›</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <!-- Filtre et recherche -->

  <div class="filters-section">
    <div class="search-box">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input
        type="text"
        placeholder="Rechercher une demande..."
        [(ngModel)]="searchQuery"
        (ngModelChange)="onFilterChange()"
        class="search-input"
      >
    </div>

    <div class="filter-group">
      <select [(ngModel)]="selectedStatus" class="filter-select">
        <option [ngValue]="null">Tous les statuts</option>
        <option [ngValue]="1">En attente</option>
        <option [ngValue]="2">Acceptée</option>
        <option [ngValue]="3">Refusée</option>
      </select>

      <select [(ngModel)]="selectedType" class="filter-select">
        <option [ngValue]="null">Tous les types</option>
        <option *ngFor="let type of typesPermission" [ngValue]="type.slug">
          {{ type.nom }}
        </option>
      </select>

      <button
        *ngIf="searchQuery || selectedStatus !== null || selectedType"
        class="btn-clear-filters"
        (click)="clearFilters()"
      >
        Effacer les filtres
      </button>
    </div>
  </div>

  <!-- Section: Toutes les permissions -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-list-ul me-2"></i>Historique de toutes les permissions
        <span class="badge bg-light text-dark ms-2">{{ toutesPermissions.length }}</span>
        <button
          class="btn btn-sm btn-outline-light"
          title="Voir les permissions archivées"
          (click)="goToArchive()"
          >
          <mat-icon class="me-1">archive</mat-icon>
          Archivées
        </button>
      </h5>
    </div>
    <div class="card-body">
      <div *ngIf="isLoadingToutes" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
      </div>

      <div *ngIf="!isLoadingToutes && toutesPermissions.length === 0" class="text-center text-muted py-4">
        <i class="bi bi-inbox fs-1"></i>
        <p class="mt-2">Aucune permission trouvée</p>
      </div>

      <div *ngIf="!isLoadingToutes && toutesPermissions.length > 0">
        <div class="table-responsive mobile-table-scroll">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Employé</th>
                <th>Type</th>
                <th>Date demande</th>
                <th>Période</th>
                <th>Durée</th>
                <th>Statut</th>
                <th>Date réponse</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let permission of paginatedToutesPermissions">
                <td>
                  <strong>{{ permission.employe?.prenom }} {{ permission.employe?.nom }}</strong><br>
                  <small class="text-muted">{{ permission.employe?.matricule }}</small>
                </td>
                <td>
                  <span class="badge bg-info">{{ permission.type?.nom }}</span>
                </td>
                <td>{{ formatDate(permission.date_demande) }}</td>
                <td>
                  <small>Du {{ formatDate(permission.debut) }}</small><br>
                  <small>Au {{ formatDate(permission.fin) }}</small>
                </td>
                <td>
                  <strong>{{ calculerDuree(permission.debut, permission.fin) }}</strong>
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatutClass(permission.statut)">
                    {{ getStatutLabel(permission.statut) }}
                  </span>
                </td>
                <td>
                  <span *ngIf="permission.date_reponse">{{ formatDate(permission.date_reponse) }}</span>
                  <span *ngIf="!permission.date_reponse" class="text-muted">-</span>
                </td>
                <td>
                  <button (click)="voirDetails(permission)" class="btn btn-sm btn-outline-primary" title="Voir détails">
                    <mat-icon>visibility</mat-icon>
                  </button> &nbsp;
                  <button (click)="generatePdf(permission)" class="btn btn-sm btn-outline-primary" title="Voir détails">
                    <mat-icon>download</mat-icon>
                  </button>
                  <button (click)="archiverPermission(permission)" class="btn btn-sm btn-outline-warning" title="Archiver la permission">
                    <mat-icon>archive</mat-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div
        *ngIf="!isLoadingToutes
          && filteredPermissions.length === 0
          && (searchQuery || selectedStatus !== null || selectedType)"
        class="no-result-wrapper text-center py-5"
      >
        <div class="no-result-icon mb-3">
          <i class="bi bi-search"></i>
        </div>

        <h5 class="fw-bold mb-2">Aucun résultat trouvé</h5>

        <p class="text-muted mb-4">
          Aucune permission ne correspond à votre recherche ou aux filtres sélectionnés.
        </p>

        <button
          class="btn btn-outline-primary btn-sm"
          (click)="clearFilters()"
        >
          <i class="bi bi-arrow-counterclockwise me-1"></i>
          Réinitialiser les filtres
        </button>
      </div>


      <nav *ngIf="totalPagesToutes > 1" class="mt-3">
        <ul class="pagination justify-content-center">

          <li class="page-item" [class.disabled]="currentPageToutes === 1">
            <a class="page-link" (click)="changerPageToutes(currentPageToutes - 1)">‹</a>
          </li>

          <li
            class="page-item"
            *ngFor="let p of [].constructor(totalPagesToutes); let i = index"
            [class.active]="currentPageToutes === i + 1">
            <a class="page-link" (click)="changerPageToutes(i + 1)">
              {{ i + 1 }}
            </a>
          </li>

          <li class="page-item" [class.disabled]="currentPageToutes === totalPagesToutes">
            <a class="page-link" (click)="changerPageToutes(currentPageToutes + 1)">›</a>
          </li>

        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Modal de réponse -->
<div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content" *ngIf="permissionSelectionnee">
      <div class="modal-header" [ngClass]="actionEnCours === 'accepter' ? 'bg-primary text-white' : 'bg-primary text-white'">
        <h5 class="modal-title">
          Details de la demande de permission
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="fermerModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Informations de l'employé -->
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-person-badge me-2"></i>Informations de l'employé</h6>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Nom :</strong> {{ permissionSelectionnee.employe?.prenom }} {{ permissionSelectionnee.employe?.nom }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Type :</strong> <span class="badge bg-info">{{ permissionSelectionnee.type?.nom }}</span></p>
                <p><strong>Statut actuel :</strong> <span class="badge" [ngClass]="getStatutClass(permissionSelectionnee.statut)">{{ getStatutLabel(permissionSelectionnee.statut) }}</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Détails de la permission -->
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-calendar-range me-2"></i>Détails de la permission</h6>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Date de demande :</strong> {{ formatDate(permissionSelectionnee.date_demande) }}</p>
                <p><strong>Date de début :</strong> {{ formatDateSort(permissionSelectionnee.debut) }}</p>
                <p><strong>Date de fin :</strong> {{ formatDateSort(permissionSelectionnee.fin) }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Durée :</strong> {{ calculerDuree(permissionSelectionnee.debut, permissionSelectionnee.fin) }}</p>
              </div>
            </div>
            <hr>
            <p><strong>Raison :</strong></p>
            <p class="text-muted">{{ permissionSelectionnee.raison }}</p>
          </div>
        </div>

        <!-- Documents joints -->
        <div class="card mb-3" *ngIf="permissionSelectionnee.documents && permissionSelectionnee.documents.length > 0">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-paperclip me-2"></i>Documents joints ({{ permissionSelectionnee.documents.length }})</h6>
            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let doc of permissionSelectionnee.documents">
                <div>
                  <i class="bi bi-file-pdf text-danger me-2"></i>
                  <strong>{{ doc.nom_fichier }}</strong>
                  <br>
                  <small class="text-muted">{{ (doc.taille / 1024 / 1024).toFixed(2) }} MB</small>
                </div>
                <button class="btn btn-sm btn-outline-primary">
                   <a [href]="doc.url" target="_blank"><i class="bi bi-download"></i> Télécharger</a>
                </button>
              </li>
            </ul>
          </div>
        </div>

        <!-- Commentaire admin (si déjà répondu) -->
        <div class="card mb-3" *ngIf="permissionSelectionnee.commentaire_admin">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-chat-left-text me-2"></i>Commentaire précédent</h6>
            <p class="text-muted">{{ permissionSelectionnee.commentaire_admin }}</p>
            <small class="text-muted">Répondu le {{ formatDate(permissionSelectionnee.date_reponse!) }}</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showModal" *ngIf="showModal" (click)="fermerModal()"></div>
