<!-- Section: Toutes les permissions -->
<div class="card shadow-sm">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">
      <i class="bi bi-list-ul me-2"></i>Historique des permissions archivées
      <span class="badge bg-light text-dark ms-2">{{ toutesPermissions.length }}</span>
      <button
          class="btn btn-sm btn-outline-light"
          title="Voir les permissions archivées"
          (click)="goToListe()"
          >
          <mat-icon class="me-1">list</mat-icon>
          Liste
        </button>
    </h5>
  </div>
  <div class="card-body">
    <div *ngIf="isLoadingToutes" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
      </div>
    </div>

    <div *ngIf="!isLoadingToutes && toutesPermissions.length === 0" class="text-center text-muted py-4">
      <i class="bi bi-inbox fs-1"></i>
      <p class="mt-2">Aucune permission archivée</p>
    </div>

    <div *ngIf="!isLoadingToutes && toutesPermissions.length > 0">
      <div class="table-responsive mobile-table-scroll">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Employé</th>
              <th>Type</th>
              <th>Date demande</th>
              <th>Période</th>
              <th>Durée</th>
              <th>Statut</th>
              <th>Date d'archivage</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let permission of paginatedToutesPermissions">
              <td>
                <strong>{{ permission.employe?.prenom }} {{ permission.employe?.nom }}</strong><br>
                <small class="text-muted">{{ permission.employe?.matricule }}</small>
              </td>
              <td>
                <span class="badge bg-info">{{ permission.type?.nom }}</span>
              </td>
              <td>{{ formatDate(permission.date_demande) }}</td>
              <td>
                <small>Du {{ formatDateSort(permission.debut) }}</small><br>
                <small>Au {{ formatDateSort(permission.fin) }}</small>
              </td>
              <td>
                <strong>{{ calculerDuree(permission.debut, permission.fin) }}</strong>
              </td>
              <td>
                <span class="badge" [ngClass]="getStatutClass(permission.statut)">
                  {{ getStatutLabel(permission.statut) }}
                </span>
              </td>
              <td>
                <span *ngIf="permission.archive">{{ formatDateSort(permission.archive) }}</span>
                <span *ngIf="!permission.archive" class="text-muted">-</span>
              </td>
              <td>
                <button (click)="voirDetails(permission)" class="btn btn-sm btn-outline-primary" title="Voir détails">
                  <mat-icon>visibility</mat-icon>
                </button> &nbsp;
                <button (click)="generatePdf(permission)" class="btn btn-sm btn-outline-primary" title="Voir détails">
                  <mat-icon>download</mat-icon>
                </button>
                <button (click)="desarchiverPermission(permission)" class="btn btn-sm btn-outline-success" title="Désarchiver la permission">
                  <mat-icon>unarchive</mat-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <nav *ngIf="totalPagesToutes > 1" class="mt-3">
      <ul class="pagination justify-content-center">

        <li class="page-item" [class.disabled]="currentPageToutes === 1">
          <a class="page-link" (click)="changerPageToutes(currentPageToutes - 1)">‹</a>
        </li>

        <li class="page-item"
            *ngFor="let p of [].constructor(totalPagesToutes); let i = index"
            [class.active]="currentPageToutes === i + 1">
          <a class="page-link" (click)="changerPageToutes(i + 1)">
            {{ i + 1 }}
          </a>
        </li>

        <li class="page-item" [class.disabled]="currentPageToutes === totalPagesToutes">
          <a class="page-link" (click)="changerPageToutes(currentPageToutes + 1)">›</a>
        </li>

      </ul>
    </nav>
  </div>
</div>

<!-- Modal de réponse -->
<div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content" *ngIf="permissionSelectionnee">
      <div class="modal-header" class="bg-primary text-white">
        <h5 class="modal-title">
          Details de la demande de permission
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="fermerModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Informations de l'employé -->
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-person-badge me-2"></i>Informations de l'employé</h6>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Nom :</strong> {{ permissionSelectionnee.employe?.prenom }} {{ permissionSelectionnee.employe?.nom }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Type :</strong> <span class="badge bg-info">{{ permissionSelectionnee.type?.nom }}</span></p>
                <p><strong>Statut actuel :</strong> <span class="badge" [ngClass]="getStatutClass(permissionSelectionnee.statut)">{{ getStatutLabel(permissionSelectionnee.statut) }}</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Détails de la permission -->
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-calendar-range me-2"></i>Détails de la permission</h6>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Date de demande :</strong> {{ formatDate(permissionSelectionnee.date_demande) }}</p>
                <p><strong>Date de début :</strong> {{ formatDateSort(permissionSelectionnee.debut) }}</p>
                <p><strong>Date de fin :</strong> {{ formatDateSort(permissionSelectionnee.fin) }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Durée :</strong> {{ calculerDuree(permissionSelectionnee.debut, permissionSelectionnee.fin) }}</p>
              </div>
            </div>
            <hr>
            <p><strong>Raison :</strong></p>
            <p class="text-muted">{{ permissionSelectionnee.raison }}</p>
          </div>
        </div>

        <!-- Documents joints -->
        <div class="card mb-3" *ngIf="permissionSelectionnee.documents && permissionSelectionnee.documents.length > 0">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-paperclip me-2"></i>Documents joints ({{ permissionSelectionnee.documents.length }})</h6>
            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let doc of permissionSelectionnee.documents">
                <div>
                  <i class="bi bi-file-pdf text-danger me-2"></i>
                  <strong>{{ doc.nom_fichier }}</strong>
                  <br>
                  <small class="text-muted">{{ (doc.taille / 1024 / 1024).toFixed(2) }} MB</small>
                </div>
                <button class="btn btn-sm btn-outline-primary">
                   <a [href]="doc.url" target="_blank"><i class="bi bi-download"></i> Télécharger</a>
                </button>
              </li>
            </ul>
          </div>
        </div>

        <!-- Commentaire admin (si déjà répondu) -->
        <div class="card mb-3" *ngIf="permissionSelectionnee.commentaire_admin">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-chat-left-text me-2"></i>Commentaire précédent</h6>
            <p class="text-muted">{{ permissionSelectionnee.commentaire_admin }}</p>
            <small class="text-muted">Répondu le {{ formatDate(permissionSelectionnee.date_reponse!) }}</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showModal" *ngIf="showModal" (click)="fermerModal()"></div>
