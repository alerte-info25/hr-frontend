<!-- src/app/components/projet-form/projet-form.component.html -->
<div class="form-container">
  <div class="form-header">
    <button class="btn-back" (click)="annuler()">
      <span class="material-icons">arrow_back</span>
    </button>
    <h1>
      <span class="material-icons">add_circle</span>
      Nouveau Projet
    </h1>
  </div>

  <form (ngSubmit)="onSubmit()" class="projet-form">

    <!-- Informations du Projet -->
    <div class="form-section">
      <h2>
        <span class="material-icons">info</span>
        Informations du Projet
      </h2>

      <div class="form-grid">
        <div class="form-group full-width">
          <label for="nom">
            Nom du projet <span class="required">*</span>
          </label>
          <input
            type="text"
            id="nom"
            [(ngModel)]="projet.nom"
            name="nom"
            placeholder="Ex: Site E-commerce ABC"
            required>
        </div>

        <div class="form-group full-width">
          <label for="description">Description</label>
          <textarea
            id="description"
            [(ngModel)]="projet.description"
            name="description"
            rows="3"
            placeholder="Description du projet..."></textarea>
        </div>

        <div class="form-group">
          <label for="montant_total">
            Montant Total <span class="required">*</span>
          </label>
          <div class="input-with-icon">
            <span class="material-icons">attach_money</span>
            <input
              type="number"
              id="montant_total"
              [(ngModel)]="projet.montant_total"
              name="montant_total"
              min="0"
              placeholder="0"
              required>
            <span class="currency">FCFA</span>
          </div>
        </div>

        <div class="form-group">
          <label for="prime_totale">
            Prime Totale <span class="required">*</span>
          </label>
          <div class="input-with-icon">
            <span class="material-icons">card_giftcard</span>
            <input
              type="number"
              id="prime_totale"
              [(ngModel)]="projet.prime_totale"
              name="prime_totale"
              min="0"
              placeholder="0"
              required>
            <span class="currency">FCFA</span>
          </div>
        </div>

        <div class="form-group">
          <label for="date_debut">Date de Début</label>
          <div class="input-with-icon">
            <span class="material-icons">event</span>
            <input
              type="date"
              id="date_debut"
              [(ngModel)]="projet.date_debut"
              name="date_debut">
          </div>
        </div>

        <div class="form-group">
          <label for="date_fin">Date de Fin</label>
          <div class="input-with-icon">
            <span class="material-icons">event</span>
            <input
              type="date"
              id="date_fin"
              [(ngModel)]="projet.date_fin"
              name="date_fin"
              [min]="projet.date_debut">
          </div>
        </div>
      </div>
    </div>

    <!-- Attribution des Primes -->
    <div class="form-section">
      <div class="section-header">
        <h2>
          <span class="material-icons">group</span>
          Attribution des Primes
        </h2>
        <div class="header-actions">
          <button
            type="button"
            class="btn btn-outline-small"
            (click)="repartirEquitablement()"
            [disabled]="attributions.length === 0">
            <span class="material-icons">balance</span>
            Répartir équitablement
          </button>
          <button
            type="button"
            class="btn btn-primary-small"
            (click)="ajouterDeveloppeur()"
            [disabled]="loadingDevs">
            <span class="material-icons">add</span>
            Ajouter un développeur
          </button>
        </div>
      </div>

      <!-- Liste des Attributions -->
      <div class="attributions-list" *ngIf="attributions.length > 0">
        <div
          class="attribution-item"
          *ngFor="let attribution of attributions; let i = index">

          <div class="attribution-number">{{ i + 1 }}</div>

          <div class="attribution-content">
            <div class="form-row">
              <div class="form-group flex-2">
                <label>Développeur <span class="required">*</span></label>
                <select
                  [(ngModel)]="attribution.employe_slug"
                  [name]="'dev_' + i"
                  (change)="onDeveloppeurChange(i)"
                  required>
                  <option value="">Sélectionner un développeur</option>
                  <option
                    *ngFor="let dev of developpeurs"
                    [value]="dev.slug">
                    {{ dev.prenom }} {{ dev.nom }}
                    <span *ngIf="dev.service"> - {{ dev.service.nom }}</span>
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label>Pourcentage <span class="required">*</span></label>
                <div class="input-with-icon">
                  <input
                    type="number"
                    [(ngModel)]="attribution.pourcentage"
                    [name]="'pourcentage_' + i"
                    min="0"
                    max="100"
                    step="0.01"
                    required>
                  <span class="unit">%</span>
                </div>
              </div>

              <div class="form-group">
                <label>Montant Prime</label>
                <div class="montant-display">
                  {{ formatMontant(calculerMontantPrime(attribution.pourcentage)) }}
                </div>
              </div>
            </div>
          </div>

          <button
            type="button"
            class="btn-remove"
            (click)="supprimerDeveloppeur(i)"
            title="Supprimer">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-attributions" *ngIf="attributions.length === 0">
        <span class="material-icons">people_outline</span>
        <p>Aucun développeur ajouté</p>
        <button
          type="button"
          class="btn btn-primary"
          (click)="ajouterDeveloppeur()"
          [disabled]="loadingDevs">
          <span class="material-icons">add</span>
          Ajouter un développeur
        </button>
      </div>

      <!-- Résumé des Pourcentages -->
      <div class="pourcentage-summary" *ngIf="attributions.length > 0">
        <div class="summary-row">
          <span class="label">Total des pourcentages :</span>
          <span class="value" [class.invalid]="!isPourcentageValid()">
            {{ getTotalPourcentage() | number:'1.0-2' }}%
          </span>
        </div>
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="getTotalPourcentage()"
            [class.invalid]="!isPourcentageValid()">
          </div>
        </div>
        <p class="validation-message" *ngIf="!isPourcentageValid()">
          <span class="material-icons">warning</span>
          Le total doit être égal à 100%
        </p>
        <p class="validation-message success" *ngIf="isPourcentageValid()">
          <span class="material-icons">check_circle</span>
          Répartition valide
        </p>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-message" *ngIf="error">
      <span class="material-icons">error</span>
      <p>{{ error }}</p>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button
        type="button"
        class="btn btn-outline"
        (click)="annuler()"
        [disabled]="loading">
        Annuler
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="!isFormValid() || loading">
        <span class="material-icons" *ngIf="!loading">save</span>
        <span class="spinner-small" *ngIf="loading"></span>
        {{ loading ? 'Enregistrement...' : 'Créer le Projet' }}
      </button>
    </div>
  </form>
</div>
